<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Retailer Map Filter</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }

        #filters {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 10;
            background: white;
            padding: 15px;
            max-width: 300px;
            max-height: 80vh;
            overflow-y: auto;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }

        .item-header {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 12px;
            color: #333;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }

        .filter-item {
            padding: 8px 12px;
            border-radius: 6px;
            transition: background 0.2s;
        }

        .filter-item:hover {
            background: #f5f5f5;
        }

        .filter-item a {
            text-decoration: none;
            color: #0080ff;
            font-size: 14px;
            display: block;
        }

        .mapboxgl-popup-content {
            padding: 15px;
            border-radius: 8px;
        }

        .mapboxgl-popup-content h2 {
            margin: 0 0 5px 0;
            font-size: 16px;
        }
    </style>
</head>

<body>

    <div id="filters"></div>
    <div id="map"></div>

    <script>
        const shopData = [];
        const filtersDiv = document.getElementById('filters');

        mapboxgl.accessToken = "pk.eyJ1IjoicHJvcGVydHlhZGFtIiwiYSI6ImNsNHBuZXdpNDBieTUzanMyN2J3NW1sMHUifQ.m5BpgLHVufA0nzdFvCpTVg";

        const map = new mapboxgl.Map({
            container: "map",
            style: "mapbox://styles/mapbox/streets-v12",
            center: { lng: -5.38319371390287, lat: 54.328587368249714 },
            zoom: 5,
            projection: "mercator"
        });

        map.addControl(new mapboxgl.NavigationControl());

        filtersDiv.innerHTML = `<div class="item-header">Loading retailers...</div>`;

        map.on('load', () => {
            d3.csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vRRCfZP7O-mr7dta_TApeE4GVpjh57jcK7r1RN2bx2RvYk3EslUZA8ay9y8-2gOu1c6-GCF26xkSLvn/pub?gid=645328569&single=true&output=csv")
                .then(data => {
                    data.forEach(shop => {
                        if (shop.property_latitude && shop.property_longitude) {
                            shopData.push({
                                ...shop,
                                sectors: (shop.sector && shop.sector.length > 0) ? shop.sector.split(",").map(i => i.trim()) : []
                            });
                        }
                    });

                    const names = new Set(shopData.map(d => d.company_name));
                    const urlParams = new URL(window.location.href).searchParams;
                    const retailerParam = urlParams.get('retailer');

                    if (retailerParam && names.has(retailerParam)) {
                        filtersDiv.style.display = 'none';
                        const filteredData = shopData.filter(d => d.company_name === retailerParam);
                        uploadPhotosBuildLayer(filteredData);
                        filterByShopNameS([retailerParam]);

                        const bounds = new mapboxgl.LngLatBounds();
                        filteredData.forEach(d => {
                            bounds.extend([+d.property_longitude, +d.property_latitude]);
                        });
                        if (!bounds.isEmpty()) {
                            map.fitBounds(bounds, { padding: 50, maxZoom: 14 });
                        }
                    } else {
                        filtersDiv.innerHTML = `
                            <div class="item-header">Retailers</div>
                            ${Array.from(names).sort().map(name => `
                                <div class="filter-item">
                                    <a href="?retailer=${encodeURIComponent(name)}">${name}</a>
                                </div>`).join("")}
                        `;
                    }
                });

            map.addSource('store', {
                'type': 'geojson',
                'data': turf.featureCollection([]),
                cluster: true,
                clusterMaxZoom: 14,
                clusterRadius: 50
            });

            map.addLayer({
                id: 'store-clusters',
                type: 'circle',
                source: 'store',
                filter: ['has', 'point_count'],
                paint: {
                    'circle-color': ['step', ['get', 'point_count'], '#51bbd6', 100, '#f1f075', 750, '#f28cb1'],
                    'circle-radius': ['step', ['get', 'point_count'], 20, 100, 30, 750, 40]
                }
            });

            map.addLayer({
                id: 'store-cluster-count',
                type: 'symbol',
                source: 'store',
                filter: ['has', 'point_count'],
                layout: {
                    'text-field': '{point_count_abbreviated}',
                    'text-font': ['DIN Offc Pro Medium', 'Arial Unicode MS Bold'],
                    'text-size': 12
                }
            });

            map.addLayer({
                id: 'storeLogo',
                'type': 'symbol',
                source: 'store',
                filter: ['!', ['has', 'point_count']],
                'layout': {
                    'icon-image': ['get', 'company_name'],
                    'icon-size': 0.15,
                    'icon-allow-overlap': true,
                }
            });

            map.on('click', 'storeLogo', (e) => {
                const props = e.features[0].properties;
                const description = `<h2>${props.company_name}</h2><p>${props.property_address}</p>`;
                new mapboxgl.Popup()
                    .setLngLat(e.lngLat)
                    .setHTML(description)
                    .addTo(map);
            });

            map.on('mouseenter', 'storeLogo', () => map.getCanvas().style.cursor = 'pointer');
            map.on('mouseleave', 'storeLogo', () => map.getCanvas().style.cursor = '');
        });

        function uploadPhotosBuildLayer(data) {
            const companyLogos = {};
            data.forEach(store => {
                if (!companyLogos[store.company_name]) {
                    companyLogos[store.company_name] = store.image;
                }
            });

            Object.keys(companyLogos).forEach(name => {
                map.loadImage(`${companyLogos[name]}`, (error, image) => {
                    if (error) {
                        map.loadImage(`logos/small/default.png`, (err, defaultImg) => {
                            if (!map.hasImage(name)) map.addImage(name, defaultImg);
                        });
                    } else {
                        if (!map.hasImage(name)) map.addImage(name, image);
                    }
                });
            });
        }

        function filterByShopNameS(shopNameArray) {
            const pins = shopData
                .filter(pin => shopNameArray.includes(pin.company_name))
                .map(pin => {
                    return turf.point([+pin.property_longitude, +pin.property_latitude], { ...pin });
                });
            map.getSource("store").setData(turf.featureCollection(pins));
        }

    </script>
</body>

</html>