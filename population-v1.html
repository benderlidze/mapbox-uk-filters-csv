<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>UK LSOA map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Mapbox GL JS -->
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.17.0/mapbox-gl.css" rel="stylesheet" />
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.17.0/mapbox-gl.js"></script>

    <!-- Mapbox Geocoder plugin -->
    <link rel="stylesheet"
        href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css"
        type="text/css" />
    <script
        src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>

    <!-- Turf.js for circle geometry -->
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@7/turf.min.js"></script>

    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }

        .search-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
            padding: 15px;
            width: 320px;
            z-index: 1;
        }

        .search-panel .mapboxgl-ctrl-geocoder {
            min-width: 100%;
            max-width: 100%;
            width: 100%;
            box-shadow: none;
        }

        .slider-container {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 13px;
            color: #333;
        }

        .slider-value {
            font-weight: 600;
            color: #0080ff;
        }

        #radius-slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e0e0e0;
            outline: none;
            -webkit-appearance: none;
        }

        #radius-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #0080ff;
            cursor: pointer;
        }

        #radius-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #0080ff;
            cursor: pointer;
            border: none;
        }

        .population-display {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 13px;
            color: #333;
        }

        .population-value {
            font-size: 20px;
            font-weight: 700;
            color: #0080ff;
            margin-top: 5px;
        }

        .loading-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 20px 40px;
            border-radius: 8px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 16px;
            font-weight: 500;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .loading-overlay.active {
            display: block;
        }

        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
            margin-right: 10px;
            vertical-align: middle;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <div id="map"></div>

    <div class="search-panel">
        <div id="geocoder"></div>
        <div class="slider-container">
            <div class="slider-label">
                <span>Radius</span>
                <span class="slider-value"><span id="radius-value">25</span> miles</span>
            </div>
            <input type="range" min="0" max="50" value="25" id="radius-slider" />
        </div>
        <div class="population-display">
            <div>Total Population</div>
            <div class="population-value" id="population-total">-</div>
        </div>
    </div>

    <div class="loading-overlay" id="loading">
        <span class="spinner"></span>
        Calculating population...
    </div>

    <script>
        mapboxgl.accessToken = 'pk.eyJ1IjoicHJvcGVydHlhZGFtIiwiYSI6ImNsNHBuZXdpNDBieTUzanMyN2J3NW1sMHUifQ.m5BpgLHVufA0nzdFvCpTVg';

        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v12',
            center: { lng: -2.774533172216252, lat: 54.12181638598531 },
            zoom: 7
        });

        map.addControl(new mapboxgl.NavigationControl(), 'top-right');

        let currentCenter = null;
        let currentRadius = 25;
        let currentCircle = null;
        let selectedLSOAs = [];

        const geocoder = new MapboxGeocoder({
            accessToken: mapboxgl.accessToken,
            mapboxgl: mapboxgl,
            marker: false,
            countries: 'gb',
            placeholder: 'Search UK addressâ€¦',
            types: 'address,place,locality,neighborhood,postcode'
        });

        document.getElementById('geocoder').appendChild(geocoder.onAdd(map));

        geocoder.on('result', (e) => {
            const center = e.result.center;
            if (center && center.length === 2) {
                currentCenter = center;
                map.flyTo({ center, zoom: 12 });
                updateCircle();
            }
        });

        const slider = document.getElementById('radius-slider');
        const radiusValue = document.getElementById('radius-value');
        const populationTotal = document.getElementById('population-total');
        const loading = document.getElementById('loading');

        // Debounce function
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Debounced update function
        const debouncedUpdate = debounce(() => {
            if (currentCenter) {
                loading.classList.add('active');
                // Use setTimeout to allow UI to update
                setTimeout(() => {
                    updateCircle();
                    loading.classList.remove('active');
                }, 50);
            }
        }, 300);

        slider.addEventListener('input', (e) => {
            currentRadius = parseInt(e.target.value);
            radiusValue.textContent = currentRadius;
            debouncedUpdate();
        });

        function updateCircle() {
            if (!currentCenter || currentRadius === 0) {
                if (map.getLayer('radius-circle')) {
                    map.removeLayer('radius-circle');
                    map.removeLayer('radius-outline');
                }
                if (map.getSource('radius')) {
                    map.removeSource('radius');
                }
                currentCircle = null;
                selectedLSOAs = [];
                updateSelection();
                return;
            }

            currentCircle = turf.circle(currentCenter, currentRadius, {
                steps: 64,
                units: 'miles'
            });

            if (map.getSource('radius')) {
                map.getSource('radius').setData(currentCircle);
            } else {
                map.addSource('radius', {
                    type: 'geojson',
                    data: currentCircle
                });

                map.addLayer({
                    id: 'radius-outline',
                    type: 'line',
                    source: 'radius',
                    paint: {
                        'line-color': 'red',
                        'line-width': 5,
                    }
                });
            }

            selectFeaturesInCircle();
        }

        function selectFeaturesInCircle() {
            if (!currentCircle || !map.getSource('population-lsoa')) {
                selectedLSOAs = [];
                updateSelection();
                return;
            }

            const features = map.querySourceFeatures('population-lsoa', {
                sourceLayer: 'clean_enriched_LSOA-5ty98a'
            });

            selectedLSOAs = [];
            let totalPopulation = 0;

            features.forEach(feature => {
                if (!feature.geometry || !feature.properties) return;

                const isInside = turf.booleanIntersects(feature, currentCircle);

                if (isInside) {
                    const lsoaCode = feature.properties.LSOA21CD;
                    if (lsoaCode && !selectedLSOAs.includes(lsoaCode)) {
                        selectedLSOAs.push(lsoaCode);
                        const pop = parseInt(feature.properties.TotalMF) || 0;
                        totalPopulation += pop;
                    }
                }
            });

            populationTotal.textContent = totalPopulation.toLocaleString();
            updateSelection();
        }

        function updateSelection() {
            if (map.getLayer('population-lsoa-fill')) {
                map.setPaintProperty('population-lsoa-fill', 'fill-color', [
                    'case',
                    ['in', ['get', 'LSOA21CD'], ['literal', selectedLSOAs]],
                    '#0080ff',
                    'transparent'
                ]);

                map.setPaintProperty('population-lsoa-fill', 'fill-opacity', [
                    'case',
                    ['in', ['get', 'LSOA21CD'], ['literal', selectedLSOAs]],
                    0.7,
                    0
                ]);
            }
        }

        map.on('load', () => {
            map.addSource('population-lsoa', {
                type: 'vector',
                url: 'mapbox://propertyadam.ccvo5o03'
            });

            map.addLayer({
                id: 'population-lsoa-fill',
                type: 'fill',
                source: 'population-lsoa',
                'source-layer': 'clean_enriched_LSOA-5ty98a',
                paint: {
                    'fill-color': 'transparent',
                    'fill-opacity': 0
                }
            });

            map.addLayer({
                id: 'population-lsoa-outline',
                type: 'line',
                source: 'population-lsoa',
                'source-layer': 'clean_enriched_LSOA-5ty98a',
                paint: {
                    'line-color': '#000000',
                    'line-width': 1,
                    'line-opacity': 0.3
                }
            });
        });
    </script>
</body>

</html>